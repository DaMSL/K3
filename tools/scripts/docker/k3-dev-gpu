#  Dockerfile:  k3-dev
#
#  Description:  Full development image for K3 and Mosaic
#
#  Version:   NVIDIA-DRIVER(352.39) CUDA(7.5) Thrust(1.8.2)
#
#  Requirements:  From k3-dev, host nvidia driver version = 352.39

# damsl/k3-dev
FROM damsl/k3-dev

ENV CUDA_RUN http://developer.download.nvidia.com/compute/cuda/7.5/Prod/local_installers/cuda_7.5.18_linux.run

ENV NVIDIA_DRIVER_VERSION 352.39
ENV CUDA_TOOLKIT_VERSION 7.5
ENV THRUST_VERSION 1.8.2

ENV CUDA_DIR cuda_7_5

# kmod for installing insmod, modprobe
RUN apt-get update && apt-get install -q -y kmod

# install nvidia-driver and cuda
RUN cd /software && \
    mkdir -p $CUDA_DIR && \
    cd $CUDA_DIR && \
    wget $CUDA_RUN && \
    chmod +x *.run && \
    ./cuda_7.5.18_linux.run -extract=`pwd`/cuda_toolkits && \
    cd cuda_toolkits && \
    ./NVIDIA-Linux-x86_64-*.run -s -N --no-kernel-module && \
    ./cuda-linux64-rel-7.5.18-*.run -noprompt

# hack on the host_config.h since currently
# nvidia cuda toolkit doesn't support gcc >= 4.9
RUN cd /usr/local/cuda-7.5/include/ && \
    sed -i -e 's/4/5/g' host_config.h

# set environment variables
ENV LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda-7.5/lib64
ENV PATH=$PATH:/usr/local/cuda-7.5/bin

RUN cd /software/$CUDA_DIR/cuda_toolkits && \
    ./cuda-samples-linux-7.5.18*.run -noprompt && \
    cd .. && rm -rf cuda_toolkits \
    rm *.run

# clean up
RUN cd /software && \
    rm -rf $CUDA_DIR

