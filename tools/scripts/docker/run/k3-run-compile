FROM damsl/k3-run:base

WORKDIR /

## Set locale for during build
ENV LANG C.UTF-8

# Install GHC and cabal
ENV PATH /opt/ghc/7.10.1/bin:/opt/cabal/1.22/bin:/opt/alex/3.1.4/bin:/opt/happy/1.19.5/bin:/root/.cabal/bin/:$PATH

RUN echo 'deb http://ppa.launchpad.net/hvr/ghc/ubuntu trusty main' > /etc/apt/sources.list.d/ghc.list && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F6F88286 && \
    apt-get update && \
    apt-get install -y --no-install-recommends zlib1g-dev cabal-install-1.22 ghc-7.10.1 happy-1.19.5 alex-3.1.4 && \
    rm -rf /var/lib/apt/lists/* 
    cabal update && \
    cabal install cabal-install -j

# Clone Repo
RUN mkdir -p /k3/K3 && \
    git clone https://github.com/DaMSL/K3.git /k3/K3

# Build K3
WORKDIR /k3/K3 

ENV K3_BRANCH development

RUN cabal sandbox init && \
    cabal install --only-dependencies --disable-documentation && \
    cabal configure && \
    cabal build

# Clean up
RUN apt-get remove -y python3 \
    rm -rf /usr/share/doc/* && \
    rm -rf /usr/share/man/* && \
    apt-get autoremove -y && \
    apt-get autoclean -y

CMD git pull && git checkout $K3_BRANCH && cabal build
