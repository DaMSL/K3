#  Dockerfile:  k3-dev
#
#  Description:  Full development image for K3 and Mosaic
#
#  Version:   GHC (7.10.1), OCaml (4.02.1), Boost (1.57), Mesos (0.22.1), Protobuf (2.5)
#
#  Requirements:  Copy mesos libs (libmesos-<version>.so, libmesos.la) to local work dir

# Debian: Sid
FROM debian:sid

ENV BOOST_VER 1.57.0
ENV BOOST_DIR boost_1_57_0

ENV PROTO_VER 2.5.0
ENV JEMALLOC_VER 4.0.0
ENV PERFTOOLS_VER 2.4

ENV MESOS_VER 0.22.1
ENV MESOS_INT_VER 0.22.1.1

ENV CABAL_VER 1.22
ENV GHC_VER 7.10.1
ENV HAPPY_VER 1.19.5
ENV ALEX_VER 3.1.4

ENV YAML_CPP_VER 0.5.1

ENV OPAMYES 1

ENV LD_LIBRARY_PATH /usr/local/lib:/usr/lib

ENV PGHOST qp2
ENV PGHOSTADDR 192.168.0.11
ENV PGUSER postgres

# Install basic packages to build the image
RUN apt-get update && apt-get install -y \
                       bzip2 unzip autoconf Libtool \
                       gcc g++ clang-3.5 make cmake git curl wget subversion pkgconf \
                       aptitude vim tmux time && \
    apt-get update && \
    apt-get install -y software-properties-common python-software-properties python-setuptools \
                       opam \
                       ruby2.2 ruby2.2-dev python python-dev python-pip \
                       postgresql-client-9.4 libpq-dev \
                       libzmq3-dev libre2-dev numactl && \
    update-alternatives \
      --install /usr/bin/ruby ruby /usr/bin/ruby2.2 50 \
      --slave /usr/bin/irb irb /usr/bin/irb2.2 \
      --slave /usr/bin/rake rake /usr/bin/rake2.2 \
      --slave /usr/bin/gem gem /usr/bin/gem2.2 \
      --slave /usr/bin/rdoc rdoc /usr/bin/rdoc2.2 \
      --slave /usr/bin/testrb testrb /usr/bin/testrb2.2 \
      --slave /usr/bin/erb erb /usr/bin/erb2.2 \
      --slave /usr/bin/ri ri /usr/bin/ri2.2 && \
    pip install pyyaml && \
    pip install flask && \
    pip install pytz && \
    pip install enum34 && \
    pip install Flask-SocketIO && \
    gem install pg && \
    opam init -a && \
    opam switch 4.02.1 && \
    eval `opam config env` && \
    opam install ocamlfind && \
    opam install yojson && \
    /bin/echo -e "\neval \`opam config env\`\n" >> /root/.bashrc && \
    /bin/echo -e "qp2:*:*:postgres:mosaic_ktrace_db\n" >> /root/.pgpass && \
    chmod 0600 /root/.pgpass

# Install Boost
RUN wget http://sourceforge.net/projects/boost/files/boost/$BOOST_VER/$BOOST_DIR.tar.bz2/download && \
  tar --bzip2 -xvf ./download && \
  rm download && \
  cd $BOOST_DIR &&  \
  ./bootstrap.sh --with-libraries=serialization,system,thread,log,program_options,filesystem --prefix=/usr/local libdir=/usr/local/lib && \
  ./b2 stage threading=multi link=shared &&  \
  ./b2 install threading=multi link=shared && \
  cd .. && \
  rm -Rf $BOOST_DIR

# Install CSV++
RUN git clone https://git01.codeplex.com/forks/wjjt/csvpp && \
  cd csvpp && \
  cmake . && \
  make && \
  mv libcsvpp.so /usr/lib/ && \
  cd .. && \
  rm -Rf csvpp

# Install libdynamic
RUN git clone https://github.com/DaMSL/libdynamic && \
  cd libdynamic &&  \
  ./autogen.sh && \
  ./configure --prefix=/usr && \
  make && \
  make install && \
  cd .. && \
  rm -Rf libdynamic

# Copy in Mesos libs & include files
ADD assets/libmesos-$MESOS_VER.so /usr/lib/
ADD assets/libmesos.la /usr/lib/
ADD assets/include/mesos /usr/include/mesos/

# Install Protobuf
RUN wget https://github.com/google/protobuf/releases/download/v$PROTO_VER/protobuf-$PROTO_VER.tar.bz2 && \
  tar -xvf protobuf-$PROTO_VER.tar.bz2 && \
  rm protobuf-$PROTO_VER.tar.bz2 && \
  cd protobuf-$PROTO_VER && \
  ./autogen.sh && \
  ./configure --prefix=/usr && \
  make && \
  make check && \
  make install && \
  protoc --proto_path=/usr/include/mesos --cpp_out=/usr/include/mesos/ /usr/include/mesos/mesos.proto && \
  cd .. && \
  rm -Rf /protobuf-$PROTO_VER

# Install jemalloc
RUN wget https://github.com/jemalloc/jemalloc/releases/download/$JEMALLOC_VER/jemalloc-$JEMALLOC_VER.tar.bz2 && \
  tar -xvf jemalloc-$JEMALLOC_VER.tar.bz2 && \
  rm jemalloc-$JEMALLOC_VER.tar.bz2 && \
  cd jemalloc-$JEMALLOC_VER && \
  ./autogen.sh && \
  ./configure --prefix=/usr && \
  make && \
  make install && \
  cd .. && \
  rm -Rf /jemalloc-$JEMALLOC_VER

# Install libunwind (a specific version for gperftools)
RUN wget http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99-beta.tar.gz && \
  tar -xvf libunwind-0.99-beta.tar.gz && \
  rm libunwind-0.99-beta.tar.gz && \
  cd libunwind-0.99-beta && \
  ./configure --prefix=/usr && \
  make && \
  make install && \
  cd / && \
  rm -Rf libunwind-0.99-beta

# Install gperftools
RUN wget https://github.com/gperftools/gperftools/releases/download/gperftools-$PERFTOOLS_VER/gperftools-$PERFTOOLS_VER.tar.gz && \
  tar -xvf gperftools-$PERFTOOLS_VER.tar.gz && \
  rm gperftools-$PERFTOOLS_VER.tar.gz && \
  cd gperftools-$PERFTOOLS_VER && \
  ./configure --prefix=/usr && \
  make && \
  make install && \
  cd .. && \
  rm -Rf /gperftools-$PERFTOOLS_VER

# Intall perf for kernel 3.13
RUN apt-get install -y flex bison libelf-dev libaudit-dev libdw-dev binutils-dev libunwind-dev && \
  wget https://github.com/torvalds/linux/archive/v3.13.tar.gz && \
  tar -xvzf v3.13.tar.gz && rm v3.13.tar.gz && \
  cd linux-3.13/tools/perf && make && make install && \
  cp perf /usr/bin && \
  cp libperf.a /usr/lib && \
  cd / && rm -Rf /linux-3.13

# Install yaml-cpp
RUN wget https://github.com/jbeder/yaml-cpp/archive/release-$YAML_CPP_VER.tar.gz && \
  tar -xvzf release-$YAML_CPP_VER.tar.gz && \
  rm release-$YAML_CPP_VER.tar.gz && \
  cd yaml-cpp-release-$YAML_CPP_VER && \
  mkdir build && cd build && \
  cmake .. && make && make install && \
  cd / && rm -Rf /yaml-cpp-release-$YAML_CPP_VER

# Install Mesos Eggs
RUN ln -s /usr/lib/libmesos-$MESOS_VER.so /usr/lib/libmesos.so && \
    wget http://downloads.mesosphere.io/master/ubuntu/14.04/mesos-$MESOS_VER-py2.7-linux-x86_64.egg && \
    wget https://pypi.python.org/packages/2.7/m/mesos.interface/mesos.interface-$MESOS_INT_VER-py2.7.egg && \
    easy_install mesos.interface-$MESOS_INT_VER-py2.7.egg && \
    easy_install --no-deps mesos-$MESOS_VER-py2.7-linux-x86_64.egg && \
    rm mesos.interface-$MESOS_INT_VER-py2.7.egg && \
    rm mesos-$MESOS_VER-py2.7-linux-x86_64.egg


# Install GHC and cabal
WORKDIR /
ENV LANG C.UTF-8
ENV PATH /opt/ghc/$GHC_VER/bin:/opt/cabal/$CABAL_VER/bin:/opt/alex/$ALEX_VER/bin:/opt/happy/$HAPPY_VER/bin:/root/.cabal/bin/:$PATH

RUN echo 'deb http://ppa.launchpad.net/hvr/ghc/ubuntu trusty main' > /etc/apt/sources.list.d/ghc.list && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F6F88286 && \
    apt-get update && \
    apt-get install -y --no-install-recommends zlib1g-dev cabal-install-$CABAL_VER ghc-$GHC_VER happy-$HAPPY_VER alex-$ALEX_VER && \
    rm -rf /var/lib/apt/lists/*  && \
    cabal update && \
    cabal install cabal-install -j

# Install decent vim configuration
RUN mkdir -p /root/.vim/autoload && mkdir -p /root/.vim/bundle \
    cd /root/.vim && \
    curl -LSso /root/.vim/autoload/pathogen.vim https://raw.githubusercontent.com/tpope/vim-pathogen/master/autoload/pathogen.vim && \
    cd /root/.vim/bundle && \
    git clone https://github.com/tpope/vim-sensible.git; \
    git clone https://github.com/tmhedberg/matchit.git; \
    git clone https://github.com/kien/ctrlp.vim.git; \
    git clone https://github.com/tpope/vim-surround.git; \
    git clone https://github.com/tpope/vim-unimpaired.git; \
    git clone https://github.com/tpope/vim-repeat.git; \
    git clone https://github.com/tpope/vim-fugitive.git; \
    git clone https://github.com/tpope/vim-vinegar.git; \
    git clone https://github.com/tpope/vim-eunuch.git; \
    git clone https://github.com/scrooloose/nerdtree.git; \
    git clone https://github.com/scrooloose/syntastic.git; \
    git clone https://github.com/godlygeek/tabular.git; \
    git clone https://github.com/bling/vim-airline.git; \
    git clone https://github.com/bronson/vim-visual-star-search.git; \
    git clone https://github.com/justinmk/vim-sneak.git; \
    echo 'execute pathogen#infect() | syntax on | filetype plugin indent on' > /root/.vimrc; \
    cd /

# Clone Repo
RUN mkdir -p /k3/K3 && \
    git clone https://github.com/DaMSL/K3.git /k3/K3

# Build K3
WORKDIR /k3/K3

ENV K3_BRANCH development

RUN git checkout development && \
    cabal sandbox init && \
    cabal install -j --only-dependencies --disable-documentation && \
    cabal configure --ghc-options="-O2" && \
    apt-get update && \
    apt-get install -y libtinfo-dev && \
    cabal build -j --ghc-options="-O2"

# Clone K3, K3-Mosaic from Git
RUN mkdir -p /k3/K3-Mosaic && \
    git clone https://github.com/DaMSL/K3-Mosaic.git /k3/K3-Mosaic

# Clean up
RUN apt-get autoremove -y && \
    apt-get autoclean -y


